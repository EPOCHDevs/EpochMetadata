src = market_data_source(timeframe="1D")
rsi_val = rsi(period=2)(src.c)
signal = rsi_val < 5

forward_calc = sql_query_4(sql="""
                               SELECT
                                   (LEAD(SLOT0, 1) OVER (ORDER BY timestamp) - SLOT0) / SLOT0 AS RESULT0,
                                   (LEAD(SLOT0, 5) OVER (ORDER BY timestamp) - SLOT0) / SLOT0 AS RESULT1,
                                   (LEAD(SLOT0, 10) OVER (ORDER BY timestamp) - SLOT0) / SLOT0 AS RESULT2,
                                   CASE WHEN SLOT1 THEN 1 ELSE 0 END AS RESULT3,
                                   timestamp
                               FROM self
                               """)(src.c, signal)

signal_returns = sql_query_4(sql="""
                                 SELECT
                                     SLOT0 AS RESULT0,
                                     SLOT1 AS RESULT1,
                                     SLOT2 AS RESULT2,
                                     1 AS RESULT3,
                                     timestamp
                                 FROM self
                                 WHERE SLOT3 = 1
                                 """)(forward_calc.RESULT0, forward_calc.RESULT1, forward_calc.RESULT2, forward_calc.RESULT3)

fwd_1d = signal_returns.RESULT0
fwd_5d = signal_returns.RESULT1
fwd_10d = signal_returns.RESULT2
count_col = signal_returns.RESULT3

win_rates = sql_query_3(sql="""
                            SELECT
                                CASE WHEN SLOT0 > 0 THEN 100.0 ELSE 0.0 END AS RESULT0,
                                CASE WHEN SLOT1 > 0 THEN 100.0 ELSE 0.0 END AS RESULT1,
                                CASE WHEN SLOT2 > 0 THEN 100.0 ELSE 0.0 END AS RESULT2,
                                timestamp
                            FROM self
                            """)(fwd_1d, fwd_5d, fwd_10d)

win_1d = win_rates.RESULT0
win_5d = win_rates.RESULT1
win_10d = win_rates.RESULT2

numeric_cards_report(agg="sum", category="Overview", title="Total RSI(2) < 5 Occurrences", group=0, group_size=1)(count_col)
numeric_cards_report(agg="mean", category="1-Day Forward", title="Average Return", group=0, group_size=2)(fwd_1d)
numeric_cards_report(agg="mean", category="1-Day Forward", title="Win Rate (%)", group=1, group_size=2)(win_1d)
numeric_cards_report(agg="mean", category="5-Day Forward", title="Average Return", group=0, group_size=2)(fwd_5d)
numeric_cards_report(agg="mean", category="5-Day Forward", title="Win Rate (%)", group=1, group_size=2)(win_5d)
numeric_cards_report(agg="mean", category="10-Day Forward", title="Average Return", group=0, group_size=2)(fwd_10d)
numeric_cards_report(agg="mean", category="10-Day Forward", title="Win Rate (%)", group=1, group_size=2)(win_10d)