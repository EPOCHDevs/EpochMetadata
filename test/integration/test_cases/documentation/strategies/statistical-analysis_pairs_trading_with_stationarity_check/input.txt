# Source: strategies/statistical-analysis.mdx:227
# Section: Statistical Analysis & Machine Learning > Pairs Trading with Stationarity Check
# Type: complete_strategy

stock_a = market_data_source(symbol="AAPL")
stock_b = market_data_source(symbol="MSFT")

spread = stock_a.c - stock_b.c

# Verify spread is stationary
stat = stationary_check(window=120, significance_level=0.05)(spread)
valid_pair = stat.is_stationary and (stat.p_value < 0.01)

# Check correlation
ret_a = (stock_a.c / stock_a.c[1] - 1) * 100
ret_b = (stock_b.c / stock_b.c[1] - 1) * 100
corr = rolling_correlation(window=60)(x=ret_a, y=ret_b)
highly_correlated = corr.result > 0.75

# Only trade if stationary AND correlated
tradeable = valid_pair and highly_correlated

# Mean reversion entry
spread_z = zscore(window=60)(spread)
entry_long_a = tradeable and (spread_z < -2)
entry_short_a = tradeable and (spread_z > 2)

# Exit on stationarity breakdown
exit = not valid_pair or not highly_correlated or (abs(spread_z) < 0.5)

trade_signal_executor()(enter_long=entry_long_a, exit_long=exit)
