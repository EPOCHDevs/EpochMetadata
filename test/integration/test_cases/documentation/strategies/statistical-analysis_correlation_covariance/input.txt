# Source: strategies/statistical-analysis.mdx:151
# Section: Statistical Analysis & Machine Learning > Correlation & Covariance
# Type: complete_strategy

src = market_data_source()
spy = market_data_source(symbol="SPY")

spy_ret = (spy.c / spy.c[1] - 1) * 100
stock_ret = (src.c / src.c[1] - 1) * 100

# Correlation for pairs trading
corr = rolling_correlation(window=60)(x=spy_ret, y=stock_ret)
cointegrated = corr.result > 0.7

# EWM for responsiveness
ewm_corr = ewm_correlation(span=30)(x=spy_ret, y=stock_ret)
correlation_breaking = (ewm_corr.result < 0.5) and (corr.result > 0.7)

# Pairs trade setup
spread = src.c - spy.c
spread_z = zscore(window=60)(spread)

entry = cointegrated and (spread_z < -2) and not correlation_breaking
exit = spread_z > 0 or correlation_breaking

trade_signal_executor()(enter_long=entry, exit_long=exit)
