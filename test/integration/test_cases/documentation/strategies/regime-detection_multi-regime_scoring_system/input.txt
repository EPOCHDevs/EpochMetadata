# Source: strategies/regime-detection.md:135
# Section: Regime Detection > Multi-Regime Scoring System
# Type: complete_strategy

src = market_data_source()

# Combine all indicators
adx_val = adx(period=14)(src.h, src.l, src.c)
di_result = di(period=14)(src.h, src.l, src.c)
vtx = vortex(period=14)(src.h, src.l, src.c)
vol = yang_zhang(period=20, trading_periods=252)(src.l, src.h, src.o, src.c)

# HMM for statistical regime
returns = (src.c / src.c[1] - 1) * 100

hmm_result = hmm(n_states=3, lookback_window=252)(returns)

# Regime scores
trending_score = (
    conditional_select(adx_val > 25, 1, 0) +
    conditional_select(abs(vtx.plus_indicator - vtx.minus_indicator) > 0.12, 1, 0)
)

bullish_score = (
    conditional_select(di_result.plus_di > di_result.minus_di, 1, 0) +
    conditional_select(vtx.plus_indicator > vtx.minus_indicator, 1, 0) +
    conditional_select(hmm_result.state == 2, 1, 0)
)

# Volatility regime using percentile_select
vol_very_low = percentile_select(lookback=252, percentile=20)(vol.result, 0, 1)
vol_high = percentile_select(lookback=252, percentile=80)(vol.result, 1, 0)

# Vol scoring: 0=very low, 1=normal, 2=high
vol_score = conditional_select(
    vol_very_low == 1, 0,
    vol_high == 1, 2,
    1
)

# Regime classification
strong_bull_trend = (trending_score >= 2) and (bullish_score >= 2) and (vol_score <= 1)
weak_bull = (bullish_score >= 2) and (trending_score < 2) and (vol_score <= 1)
high_vol_avoid = vol_score == 2

# Strategy routing based on regime
# strong_bull_trend: use trend-follow (EMA crossover)
# weak_bull: buy dips (RSI oversold)
# other regimes: avoid trading
entry = conditional_select(
    strong_bull_trend, ema(period=20)(src.c) > ema(period=50)(src.c),
    weak_bull, rsi(period=14)(src.c) < 35,
    0
)

exit = high_vol_avoid or not (strong_bull_trend or weak_bull)

trade_signal_executor()(enter_long=entry, exit_long=exit)
